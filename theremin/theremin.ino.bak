/*
 *  HC-SR04 test1.
 *  Simple oscillator, with pitch changed by distance.
 *  Author: Tsz Kiu Pang
 *  Date: 26/01/2019
 */

#include <MozziGuts.h>
#include <Oscil.h>
#include <tables/sin2048_int8.h>

const int HEAD_SPACE = 2;
const int PING_LEN = 10;
const int TRIG_PIN = 2;
const int ECHO_PIN = 3;
const double HALF_SPEED_OF_SOUND = 0.1715; //cm per microsec

enum STAGES {
  LO, HI, HI_END, GET_DIST_START, GET_DIST_END, DONE
};

Oscil <SIN2048_NUM_CELLS, AUDIO_RATE> aSin(SIN2048_DATA);

unsigned long ul_start_time=0.0, ul_end_time=0.0;
double d_dist=0.0;
byte b_stage;
byte count=0;

void
setup() {
  // put your setup code here, to run once:
  int freq = 440;
  b_stage = LO;
  aSin.setFreq(freq);
  pingSetup();
  Serial.begin(9600);
  startMozzi();
}

void
updateControl() {
  byte tmp = b_stage;
  b_stage = pingCtrl(tmp, ul_start_time, ul_end_time, &d_dist);
  Serial.println(b_stage);
}

int
updateAudio() {
  byte tmp = b_stage;
  b_stage = pingEcho(tmp, &ul_start_time, &ul_end_time);
  return aSin.next();
}

void
loop() {
  audioHook();
}

void
pingSetup() {
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  digitalWrite(TRIG_PIN, LOW);
}

byte
pingCtrl(byte stage, unsigned long start_time,
         unsigned long end_time, double *dist) {
  //Serial.println(stage);
  if (stage == LO) {
    digitalWrite(TRIG_PIN, LOW);
    return HI;
  }
  if (stage == HI) {
    digitalWrite(TRIG_PIN, HIGH);
    return HI_END;
  }
  if (stage == HI_END) {
    digitalWrite(TRIG_PIN, LOW);
    count = 0;
    return GET_DIST_START;
  }
  if (stage == DONE) {
    *dist = calcDist(start_time, end_time, *dist);
    return LO;
  }
}

double
calcDist(unsigned long start_time, unsigned long end_time,
         double dist) {
  return (double)(end_time - start_time) * HALF_SPEED_OF_SOUND;
}

byte
pingEcho(byte stage, unsigned long* start_time,
         unsigned long* end_time) {
  if (stage == GET_DIST_START) {
    if (count++>AUDIO_RATE/10) return DONE;
    if (digitalRead(ECHO_PIN) == HIGH) {
      *start_time = mozziMicros();
      return GET_DIST_END;
    }
  }
  if (stage == GET_DIST_END) {
    if (digitalRead(ECHO_PIN) == LOW) {
      *end_time = mozziMicros();
      return DONE;
    }
  }
  return stage;
}
